conf t

ip cef

ipv6 unicast-routing !ipv6 routing enabled

int f0/0
no shut
ip add 4.20.20.6 255.255.255.252
ipv6 enable
ipv6 add 2001:420:2::2/64

int f0/1
no shut
ip add 4.20.20.14 255.255.255.252
ipv6 enable
ipv6 add 2001:420:4::2/64

int f1/1
ip add 192.172.100.3 255.255.255.128
no shut
ipv6 enable
ipv6 add 2001:192:100::3/50
ip ospf 1 area 0
ipv6 ospf 1 area 0
ip rsvp bandwidth 2048 2048

interface tunnel1
ip unnumbered Loopback0
tunnel destination 10.1.0.2
tunnel mode mpls traffic-eng
tunnel mpls traffic-eng bandwidth 1024
tunnel mpls traffic-eng path-option 1 explicit name lisboa_aveiro

ip explicit-path name lisboa_aveiro enable
next-address 192.172.100.2

interface tunnel2
ip unnumbered Loopback0
tunnel destination 10.1.0.4
tunnel mode mpls traffic-eng
tunnel mpls traffic-eng bandwidth 1024
tunnel mpls traffic-eng path-option 1 explicit name lisboa_faro

ip explicit-path name lisboa_faro enable
next-address 192.172.100.4

int f1/0
no shut
ip add 192.172.100.129 255.255.255.128
ipv6 enable
ipv6 add 2001:192:101::129/48
ip policy route-map SIPProxyNet

int lo0
ip add 10.1.0.3 255.255.255.255
ip ospf 1 area 0
no shut

! NON - TRANSIT
ip as-path access-list 1 permit ^$
route-map non-transit
match as-path 1

! COMMUNITIES
ip bgp-community new-format

access-list 1 permit 0.0.0.0 0.0.0.0
ip community-list 1 permit 0:1

! enviar a community para as rotas de netL1 e netL2
route-map rotas-para-faro permit 10
match community 1
set community 1:2

route-map rotas-para-faro permit 20
match ip address 1
set community 1:4

route-map rotas-para-faro permit 30

! usado para enviar o 0.0.0.0 em community para Aveiro e para Faro
! isto vai permitir que depois Aveiro (e Faro) facam a escolha para
! encaminhar por lisboa
route-map rota-default permit 30
match ip address 1
set community 1:3

route-map rota-default permit 50

! route map usado para todo o que for para a internet ir para Sintra pelo
! ISP S, aumentando a preferencia para a rota recebida por sintra
route-map default-goes-sintra permit 40
match ip address 1
set local-preference 111

route-map default-goes-sintra permit 60

! IP traffic for remote SIP proxy 2 (to network netS1) should be routed only
! via Lisboa using the direct peering link to ISP S.
access-list 101 permit ip 192.172.100.130 0.0.0.127 200.1.100.1 0.0.0.255

route-map SIPProxyNet permit 70
match ip add 101
set ip next-hop 4.20.20.13

! SIP TRAFFIC TO THE TUNNEL
access-list 104 permit ip 192.172.100.130 0.0.0.127 80.172.100.130 0.0.0.63
access-list 102 permit ip 192.172.100.130 0.0.0.127 81.84.100.2 0.0.0.255
access-list 103 permit ip 192.172.100.130 0.0.0.127 80.172.100.194 0.0.0.63

route-map SIPProxyNet permit 80
match ip add 104 102
set interface tunnel1

route-map SIPProxyNet permit 90
match ip add 103
set interface tunnel2

! BGP CONFIGS
router bgp 9.345

address-family ipv4 unicast

neighbor 4.20.20.13 remote-as 8657 !eBGP Neighboring with Sintra
neighbor 4.20.20.13 route-map non-transit out
neighbor 4.20.20.13 route-map default-goes-sintra in

neighbor 4.20.20.5 remote-as 34419 !eBGP Neighboring with London
neighbor 4.20.20.5 route-map non-transit out

neighbor 10.1.0.1 remote-as 9.345
neighbor 10.1.0.1 next-hop-self
neighbor 10.1.0.1 update-source Loopback 0

neighbor 10.1.0.2 remote-as 9.345
neighbor 10.1.0.2 next-hop-self
neighbor 10.1.0.2 update-source Loopback 0
neighbor 10.1.0.2 route-map rota-default out
neighbor 10.1.0.2 send-community

neighbor 10.1.0.4 remote-as 9.345
neighbor 10.1.0.4 next-hop-self
neighbor 10.1.0.4 update-source Loopback 0
neighbor 10.1.0.4 route-map rotas-para-faro out
neighbor 10.1.0.4 send-community

network 192.172.100.128 mask 255.255.255.128 !netX1
network 192.172.100.0 mask 255.255.255.128 ! do ethernet core

aggregate-address 80.172.100.128 255.255.255.128 summary-only

!! IPV6

address-family ipv6 unicast

neighbor 2001:420:4::1 remote-as 8657
neighbor 2001:420:4::1 activate
neighbor 2001:420:4::1 route-map non-transit out
neighbor 2001:420:4::1 route-map default-goes-sintra in

neighbor 2001:420:2::1 remote-as 34419
neighbor 2001:420:2::1 activate
neighbor 2001:420:2::1 route-map non-transit out

neighbor 2001:192:100::1 remote-as 9.345
neighbor 2001:192:100::1 activate

neighbor 2001:192:100::2 remote-as 9.345
neighbor 2001:192:100::2 activate
neighbor 2001:192:100::2 route-map rota-default out
neighbor 2001:192:100::2 send-community

neighbor 2001:192:100::4 remote-as 9.345
neighbor 2001:192:100::4 activate
neighbor 2001:192:100::4 route-map rotas-para-faro out
neighbor 2001:192:100::4 send-community

network 2001:192:101::/48
network 2001:192:100::/50

end
write
